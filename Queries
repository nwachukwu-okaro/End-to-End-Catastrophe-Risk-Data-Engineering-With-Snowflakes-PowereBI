----THE PROJECT SETUP-------
-- 1. Create the Database and Schemas 
CREATE OR REPLACE DATABASE UK_INSURANCE_PROJ;
CREATE OR REPLACE SCHEMA RAW;        
CREATE OR REPLACE SCHEMA ANALYTICS;  

-- 2. Create a dedicated Warehouse 
CREATE OR REPLACE WAREHOUSE INS_WH 
    WAREHOUSE_SIZE = 'XSMALL' 
    AUTO_SUSPEND = 60 
    AUTO_RESUME = TRUE 
    COMMENT = 'Warehouse for UK Insurance Risk Project';

-- 3. Create a Project Role 
USE ROLE SECURITYADMIN;
CREATE OR REPLACE ROLE INS_ENGINEER_ROLE;

-- 4. Grant permissions
GRANT USAGE ON DATABASE UK_INSURANCE_PROJ TO ROLE INS_ENGINEER_ROLE;
GRANT ALL PRIVILEGES ON SCHEMA UK_INSURANCE_PROJ.RAW TO ROLE INS_ENGINEER_ROLE;
GRANT ALL PRIVILEGES ON SCHEMA UK_INSURANCE_PROJ.ANALYTICS TO ROLE INS_ENGINEER_ROLE;
GRANT USAGE ON WAREHOUSE INS_WH TO ROLE INS_ENGINEER_ROLE;

-- Assigned the role to myself
GRANT ROLE INS_ENGINEER_ROLE TO USER NWACHUKWU; 

USE ROLE INS_ENGINEER_ROLE;

-----DATA INGESTATION-----

CREATE OR REPLACE TABLE UK_INSURANCE_PROJ.RAW.LONDON_PROPERTIES_RAW (
    POLICY_ID STRING,
    POSTCODE_DISTRICT STRING, -- e.g., 'SE1', 'E1'
    LATITUDE FLOAT,
    LONGITUDE FLOAT,
    INSURED_VALUE NUMBER(15,2),
    CONSTRUCTION_YEAR INT,
    LOADED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()
);

--Generate random data.This apporach was necessary to replace the real data and avoid privacy breach.

INSERT INTO UK_INSURANCE_PROJ.RAW.LONDON_PROPERTIES_RAW (POLICY_ID, LATITUDE, LONGITUDE, INSURED_VALUE, CONSTRUCTION_YEAR, POSTCODE_DISTRICT)
SELECT 
    'UK-POL-' || seq4(),
    51.45 + (uniform(0, 1000, random()) / 10000), -- Random Lat near London
    -0.15 + (uniform(0, 1000, random()) / 5000),  -- Random Lon near London
    uniform(150000, 2000000, random()),           -- Random Value between £150k and £2m
    uniform(1900, 2024, random()),                -- Random Year
    'SE' || uniform(1, 20, random())              -- Random SE Postcode
FROM TABLE(GENERATOR(ROWCOUNT => 10000));

SELECT * FROM LONDON_PROPERTIES_RAW
LIMIT 3

--Create a view to select the informations we want to work with

CREATE OR REPLACE VIEW UK_INSURANCE_PROJ.ANALYTICS.VW_PROPERTIES_GEOLOCATED AS
SELECT 
    POLICY_ID,
    INSURED_VALUE,
    -- Create Snowflake Geography point
    ST_POINT(LONGITUDE, LATITUDE) as PROPERTY_LOCATION,
    CONSTRUCTION_YEAR,
    -- Categorize by property value
    CASE 
        WHEN INSURED_VALUE > 1000000 THEN 'High Net Worth'
        WHEN INSURED_VALUE > 500000 THEN 'Mid Market'
        ELSE 'Standard'
    END as POLICY_SEGMENT
FROM UK_INSURANCE_PROJ.RAW.LONDON_PROPERTIES_RAW;

Select POLICY_ID,INSURED_VALUE,POLICY_SEGMENT,PROPERTY_LOCATION
FROM VW_PROPERTIES_GEOLOCATED
limit 3

---Intersect the the flood risk area with the property area to determine propertiee/values at risk

CREATE OR REPLACE VIEW UK_INSURANCE_PROJ.ANALYTICS.FACT_EXPOSURE_SUMMARY AS
WITH THAMES_FLOOD_ZONE AS (
    -- Simulating a high-risk polygon around the Thames
    SELECT TO_GEOGRAPHY('POLYGON((-0.15 51.50, -0.05 51.50, -0.05 51.52, -0.15 51.52, -0.15 51.50))') as SHAPE
)
SELECT 
    p.POLICY_ID,
    p.POLICY_SEGMENT,
    p.INSURED_VALUE,
    -- Check if the property is INSIDE the flood zone
    ST_INTERSECTS(p.PROPERTY_LOCATION, f.SHAPE) as IS_IN_FLOOD_ZONE
FROM UK_INSURANCE_PROJ.ANALYTICS.VW_PROPERTIES_GEOLOCATED p, THAMES_FLOOD_ZONE f;

-------FURTHER ANALYSIS------
-- Total financial exposure within the flood zone
SELECT 
    COUNT(POLICY_ID) as AT_RISK_COUNT,
    SUM(INSURED_VALUE) as TOTAL_VALUE_AT_RISK_GBP,
    AVG(INSURED_VALUE) as AVG_PROPERTY_VALUE_AT_RISK
FROM UK_INSURANCE_PROJ.ANALYTICS.FACT_EXPOSURE_SUMMARY
WHERE IS_IN_FLOOD_ZONE = TRUE;

-- Identify the top 10 most expensive properties at risk
SELECT 
    POLICY_ID,
    INSURED_VALUE,
    POLICY_SEGMENT
FROM UK_INSURANCE_PROJ.ANALYTICS.FACT_EXPOSURE_SUMMARY
WHERE IS_IN_FLOOD_ZONE = TRUE
ORDER BY INSURED_VALUE DESC
LIMIT 10;

------REQUEST SECURITYADMIN ROLE TO Enable Ability To for role to grant access

USE ROLE SECURITYADMIN;

-- Grant usage on the schema WITH GRANT OPTION
GRANT USAGE ON SCHEMA UK_INSURANCE_PROJ.ANALYTICS 
TO ROLE INS_ENGINEER_ROLE WITH GRANT OPTION;

-- Grant select on all future views so it can be shared
GRANT SELECT ON FUTURE VIEWS IN SCHEMA UK_INSURANCE_PROJ.ANALYTICS 
TO ROLE INS_ENGINEER_ROLE WITH GRANT OPTION;





----------Granting Permission For Other Role/USERS to Assess and Use --


-- 1. Create a specific role for Analysts
CREATE OR REPLACE ROLE ANALYST_READ_ROLE;

-- 2. Grant permissions to see the database and schema
GRANT USAGE ON DATABASE UK_INSURANCE_PROJ TO ROLE ANALYST_READ_ROLE;
GRANT USAGE ON SCHEMA UK_INSURANCE_PROJ.ANALYTICS TO ROLE ANALYST_READ_ROLE;

-- 3. Grant permission to read the views
GRANT SELECT ON ALL VIEWS IN SCHEMA UK_INSURANCE_PROJ.ANALYTICS TO ROLE ANALYST_READ_ROLE;

-- 4. Grant permission to use the warehouse 
GRANT USAGE ON WAREHOUSE INS_WH TO ROLE ANALYST_READ_ROLE;

-- 5. Assign this role to a specific user (or yourself for testing)
GRANT ROLE ANALYST_READ_ROLE TO USER JohnDoe;
